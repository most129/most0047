import os
import shutil
import zipfile

def process_epub_files(epub_folder, css_he_file, css_ru_file):
    for file_name in os.listdir(epub_folder):
        if file_name.endswith(".epub"):
            file_path = os.path.join(epub_folder, file_name)
            result = process_epub_file(file_path, css_he_file, css_ru_file)
            print(f"{file_name}: {result}")

def process_epub_file(epub_file, css_he_file, css_ru_file):
    try:
        temp_folder = os.path.splitext(epub_file)[0]
        os.makedirs(temp_folder, exist_ok=True)
        with zipfile.ZipFile(epub_file, "r") as zip_ref:
            zip_ref.extractall(temp_folder)

        css_file = css_he_file if "_he_" in epub_file else css_ru_file
        css_file_dest = os.path.join(temp_folder, "OPS", "css", "book1.css")
        shutil.copy(css_file, css_file_dest)

        new_epub_file = os.path.splitext(epub_file)[0] + "_new.epub"
        with zipfile.ZipFile(new_epub_file, "w") as zip_ref:
            for folder_name, _, file_names in os.walk(temp_folder):
                for file in file_names:
                    file_path = os.path.join(folder_name, file)
                    arc_name = os.path.relpath(file_path, temp_folder)
                    zip_ref.write(file_path, arc_name)

        shutil.rmtree(temp_folder)
        os.rename(new_epub_file, epub_file)

        return "succeed"
    except Exception as e:
        return f"failed, {str(e)}"

# epub_folder = "путь_к_папке_с_epub_файлами"
# css_he_file = "путь_к_ивритскому_css_файлу"
# css_ru_file = "путь_к_русскому_css_файлу"

epub_folder = "epub_folder"
css_he_file = "css_he_file"
css_ru_file = "css_ru_file"

process_epub_files(epub_folder, css_he_file, css_ru_file)
